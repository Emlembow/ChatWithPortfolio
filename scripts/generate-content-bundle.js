const fs = require('fs');
const path = require('path');
const matter = require('gray-matter');

// This script generates a content bundle that can be imported at build time
// This ensures content is available in Vercel's serverless environment

function readAllContent() {
  const contentDir = path.join(__dirname, '..', 'content');
  const content = {};
  
  // Read single files
  const singleFiles = [
    'profile.md',
    'about.md',
    'education.md',
    'system-prompt.md',
    'system-prompt-extended.md'
  ];
  
  singleFiles.forEach(file => {
    const filePath = path.join(contentDir, file);
    if (fs.existsSync(filePath)) {
      const raw = fs.readFileSync(filePath, 'utf8');
      const parsed = matter(raw);
      content[file.replace('.md', '')] = {
        data: parsed.data,
        content: parsed.content,
        raw: raw
      };
    }
  });
  
  // Read directories
  const directories = ['experience', 'projects', 'references', 'blog'];
  
  directories.forEach(dir => {
    const dirPath = path.join(contentDir, dir);
    if (fs.existsSync(dirPath)) {
      content[dir] = [];
      const files = fs.readdirSync(dirPath).filter(f => f.endsWith('.md'));
      files.forEach(file => {
        const filePath = path.join(dirPath, file);
        const raw = fs.readFileSync(filePath, 'utf8');
        const parsed = matter(raw);
        content[dir].push({
          id: file.replace('.md', ''),
          data: parsed.data,
          content: parsed.content,
          raw: raw
        });
      });
    }
  });
  
  return content;
}

// Generate the content bundle
const contentBundle = readAllContent();

// Write to a TypeScript file
const output = `// This file is auto-generated by scripts/generate-content-bundle.js
// Do not edit manually

export const CONTENT_BUNDLE = ${JSON.stringify(contentBundle, null, 2)} as const;

export type ContentBundle = typeof CONTENT_BUNDLE;
`;

const outputPath = path.join(__dirname, '..', 'lib', 'content-bundle.ts');
fs.writeFileSync(outputPath, output);

console.log('Content bundle generated successfully at lib/content-bundle.ts');